# [advice from AI] KTV 실시간 AI 자동자막 POC - Docker Compose

services:
  # [advice from AI] HTTPS 프록시 (nginx) - 포트 6443 사용
  nginx:
    image: nginx:alpine
    container_name: ktv-nginx
    ports:
      - "6443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    depends_on:
      - frontend
      - backend
      - whisper-livekit
    restart: unless-stopped

  # [advice from AI] WhisperLiveKit - 실시간 STT 서버
  whisper-livekit:
    build:
      context: /home/rickyson/Ricky-Dev/WhisperLiveKit
      dockerfile: Dockerfile
    container_name: ktv-whisper-livekit
    ports:
      - "6470:8000"
    # [advice from AI] GPU 사용 설정 - GPU가 없으면 아래 deploy 섹션 주석 처리
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    volumes:
      # [advice from AI] 로컬 Hugging Face 캐시 마운트 (읽기/쓰기 - 모델 다운로드 가능)
      - /home/rickyson/.cache/huggingface/hub:/root/.cache/huggingface/hub
      # [advice from AI] WhisperLiveKit 소스 마운트 (로그 레벨 변경 적용)
      - /home/rickyson/Ricky-Dev/WhisperLiveKit/whisperlivekit:/opt/venv/lib/python3.12/site-packages/whisperlivekit
    # [advice from AI] 로그 레벨을 DEBUG로 설정하여 모델 로드 로그 확인
    environment:
      - PYTHONUNBUFFERED=1
    # [advice from AI] large-v3 모델 사용 (가장 정확한 모델, 한국어 지원)
    # [advice from AI] --pcm-input: FFmpeg 없이 직접 PCM 수신 (안정성 향상)
    # [advice from AI] --backend-policy localagreement: 안정적인 정책 사용
    # [advice from AI] --init-prompt: 컨텍스트 힌트로 인식 정확도 향상
    # [advice from AI] Dockerfile ENTRYPOINT가 "whisperlivekit-server --host 0.0.0.0"이므로 command는 추가 인수만 전달
    command: ["--model", "large-v3", "--language", "ko", "--pcm-input", "--backend-policy", "localagreement", "--init-prompt", "국무회의, 국민의례, 경례, 대통령, 국무총리, 장관, 정책, 예산, 법안, 의결"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 백엔드 API 서비스
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ktv-poc-backend
    ports:
      - "6431:6431"
    # [advice from AI] Linux에서 컨테이너가 호스트에 접근할 수 있도록 설정
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # HAIV STT 설정
      - HAIV_URL=haiv.timbel.net:40001
      - HAIV_CHANNEL=1
      - HAIV_BYTERATE=16000
      - HAIV_MODEL=KOREAN_ONLINE_8K
      - HAIV_PROJECT_ID=2ec95f1c-3b52-4eaa-a29a-6065e2d95d61
      - HAIV_CLIENT_PATH=/app/haiv/HAIV_client.py
      # [advice from AI] WhisperLiveKit 연결 설정 (Docker 내부 통신)
      - WHISPER_HOST=whisper-livekit
      - WHISPER_PORT=8000
      # 기타 설정
      - UPLOAD_DIR=/tmp/ktv-uploads
      - ENVIRONMENT=development
    volumes:
      # HAIV 클라이언트 마운트 (실제 클라이언트 파일이 있는 경로로 수정 필요)
      - ./haiv:/app/haiv:ro
      # 업로드 파일 저장
      - ktv-uploads:/tmp/ktv-uploads
      # [advice from AI] Docker 소켓 마운트 (STT 컨테이너 재시작용)
      - /var/run/docker.sock:/var/run/docker.sock
      # [advice from AI] 개발 모드 - 소스 코드 볼륨 마운트 (코드 변경 즉시 반영)
      - ./backend/app:/app/app
    depends_on:
      - whisper-livekit
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6431/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 프론트엔드 서비스 (개발용)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ktv-poc-frontend
    ports:
      - "6430:6430"
    # [advice from AI] VITE_API_URL 제거 - 코드에서 동적으로 호스트 감지
    volumes:
      # [advice from AI] 개발 모드 - 소스 볼륨 마운트 (코드 변경 즉시 반영)
      - ./frontend/src:/app/src
      - ./frontend/index.html:/app/index.html
      - ./frontend/vite.config.ts:/app/vite.config.ts
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  ktv-uploads:
