# STT-Full-Service API ê°€ì´ë“œ

ì‹¤ì‹œê°„ ë°©ì†¡ ìë§‰ìš© STT(Speech-to-Text) ì„œë¹„ìŠ¤ API ë¬¸ì„œ

---

## ğŸ“Œ ì„œë¹„ìŠ¤ ì •ë³´

| í•­ëª© | ê°’ |
|------|---|
| **ì„œë¹„ìŠ¤ëª…** | STT-Full-Service |
| **í¬íŠ¸** | 6470 |
| **í”„ë¡œí† ì½œ** | HTTP (REST), WebSocket |
| **ì˜¤ë””ì˜¤ í˜•ì‹** | PCM (int16, mono) |
| **ì§€ì› ìƒ˜í”Œë ˆì´íŠ¸** | 16000Hz (ê¶Œì¥), 32000Hz, 44100Hz, 48000Hz |

---

## ğŸ”— ì ‘ì† ì •ë³´

### ì—”ë“œí¬ì¸íŠ¸

```
# REST API (Health Check)
http://<HOST>:6470/api/v1/health

# WebSocket (ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°) - ì‹ ê·œ API
ws://<HOST>:6470/api/v1/stream

# WebSocket (whisper-stt-server í˜¸í™˜) - ê¸°ì¡´ í´ë¼ì´ì–¸íŠ¸ìš© â­
ws://<HOST>:6470/client/ws/speech

# ê´€ë¦¬ í˜ì´ì§€
http://<HOST>:6470/admin
```

### ë¡œì»¬ í…ŒìŠ¤íŠ¸
```
http://localhost:6470/api/v1/health
ws://localhost:6470/api/v1/stream
ws://localhost:6470/client/ws/speech?model=KOREAN_16K&lang=ko
http://localhost:6470/admin
```

---

## ğŸ“¡ REST API

### GET /api/v1/health

ì„œë²„ ìƒíƒœ í™•ì¸

#### ìš”ì²­
```bash
curl http://localhost:6470/api/v1/health
```

#### ì‘ë‹µ
```json
{
  "status": "healthy",
  "whisper_model": "large-v3",
  "device": "cuda",
  "vad_loaded": true,
  "speaker_model_loaded": true
}
```

---

## ğŸ”„ í˜¸í™˜ API (whisper-stt-server í˜¸í™˜) â­ ì¶”ì²œ

ê¸°ì¡´ `whisper-stt-server:6050` í´ë¼ì´ì–¸íŠ¸ê°€ **í¬íŠ¸ë§Œ ë³€ê²½**í•˜ë©´ ì‚¬ìš© ê°€ëŠ¥

### ì—°ê²°

```
ws://<HOST>:6470/client/ws/speech?model=KOREAN_16K&lang=ko
```

### íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„° | ê¸°ë³¸ê°’ | ì„¤ëª… |
|---------|--------|------|
| `model` | `KOREAN_16K` | ëª¨ë¸ëª… (ìƒ˜í”Œë ˆì´íŠ¸ ê²°ì •) |
| `lang` | `ko` | ì–¸ì–´ ì½”ë“œ |

### ì§€ì› ëª¨ë¸

| ëª¨ë¸ | ìƒ˜í”Œë ˆì´íŠ¸ |
|------|-----------|
| `KOREAN_8K` | 8,000 Hz |
| `KOREAN_16K` | 16,000 Hz |
| `KOREAN_32K` | 32,000 Hz |

### ì‘ë‹µ í˜•ì‹ (HAIV ìŠ¤íƒ€ì¼ ì‹¤ì‹œê°„)

#### ì¤‘ê°„ ê²°ê³¼ (ë°œí™” ê°ì§€ ì‹œë§ˆë‹¤)
```json
{
    "type": "segment",
    "text": "êµ­ë¬´ì´ë¦¬ê»˜ì„œ ë‹µë³€í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.",
    "start": 0.0,
    "end": 2.5,
    "speaker_changed": false,
    "segment_id": 1,
    "final": false
}
```

#### ìµœì¢… ê²°ê³¼ (EOS ì‹œ)
```json
{
    "type": "final",
    "text": "ì „ì²´ í…ìŠ¤íŠ¸ (ì¤„ë°”ê¿ˆ í¬í•¨)",
    "segments": [...],
    "total_duration": 5.0,
    "total_segments": 10,
    "final": true
}
```

### ë§ˆì´ê·¸ë ˆì´ì…˜

```diff
- ws://localhost:6050/client/ws/speech?model=KOREAN_16K&lang=ko
+ ws://localhost:6470/client/ws/speech?model=KOREAN_16K&lang=ko
```

**í¬íŠ¸ë§Œ ë³€ê²½!** (6050 â†’ 6470)

---

## ğŸ™ï¸ WebSocket API (ì‹ ê·œ API)

### ì—°ê²°

#### URL í˜•ì‹
```
ws://<HOST>:6470/api/v1/stream?lang=<ì–¸ì–´>&sample_rate=<ìƒ˜í”Œë ˆì´íŠ¸>&speaker_change=<í™”ìê°ì§€>
```

#### íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„° | íƒ€ì… | í•„ìˆ˜ | ê¸°ë³¸ê°’ | ì„¤ëª… |
|---------|------|------|--------|------|
| `lang` | string | âŒ | `ko` | ì–¸ì–´ ì½”ë“œ (ko, en, ja, zh ë“±) |
| `sample_rate` | int | âŒ | `16000` | ì˜¤ë””ì˜¤ ìƒ˜í”Œë ˆì´íŠ¸ (Hz) |
| `speaker_change` | bool | âŒ | `true` | í™”ì ë³€ê²½ ê°ì§€ í™œì„±í™” |

#### ì˜ˆì‹œ
```
ws://localhost:6470/api/v1/stream?lang=ko&sample_rate=16000&speaker_change=true
```

---

## ğŸ“¤ ë°ì´í„° ì „ì†¡ í˜•ì‹

### ì˜¤ë””ì˜¤ ë°ì´í„° ì „ì†¡

| í•­ëª© | ê°’ |
|------|---|
| **í˜•ì‹** | Raw PCM (binary) |
| **ë¹„íŠ¸ ê¹Šì´** | 16-bit signed integer (int16) |
| **ì±„ë„** | Mono (1 channel) |
| **ë°”ì´íŠ¸ ìˆœì„œ** | Little-endian |
| **ê¶Œì¥ ì²­í¬ í¬ê¸°** | 4096 ~ 16000 bytes |

#### ì „ì†¡ íë¦„

```
í´ë¼ì´ì–¸íŠ¸                           ì„œë²„
   â”‚                                  â”‚
   â”‚â”€â”€â”€â”€ [ì˜¤ë””ì˜¤ ì²­í¬ 1] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                                  â”‚
   â”‚â”€â”€â”€â”€ [ì˜¤ë””ì˜¤ ì²­í¬ 2] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                                  â”‚
   â”‚â—€â”€â”€â”€â”€ { type: "segment" } â”€â”€â”€â”€â”€â”€â”€â”€â”‚  (ì¸ì‹ ê²°ê³¼)
   â”‚                                  â”‚
   â”‚â”€â”€â”€â”€ [ì˜¤ë””ì˜¤ ì²­í¬ N] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                                  â”‚
   â”‚â”€â”€â”€â”€ "EOS" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  (ì „ì†¡ ì¢…ë£Œ ì‹ í˜¸)
   â”‚                                  â”‚
   â”‚â—€â”€â”€â”€â”€ { type: "final" } â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  (ìµœì¢… ê²°ê³¼)
   â”‚                                  â”‚
```

### ì „ì†¡ ì¢…ë£Œ

ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ ì‹œ **ë¬¸ìì—´ `"EOS"`** ì „ì†¡:

```python
await websocket.send("EOS")
```

---

## ğŸ“¥ ì‘ë‹µ í˜•ì‹

### 1. ì„¸ê·¸ë¨¼íŠ¸ ì‘ë‹µ (ì‹¤ì‹œê°„)

ë°œí™” êµ¬ê°„ì´ ì¸ì‹ë  ë•Œë§ˆë‹¤ ì „ì†¡

```json
{
  "type": "segment",
  "segment_id": 1,
  "text": "ì˜¤ëŠ˜ íšŒì˜ì—ì„œ ë…¼ì˜í•  ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤",
  "start_time": 1706875200.123,
  "end_time": 1706875203.456,
  "speaker_changed": false,
  "speaker_id": 0,
  "confidence": 0.92
}
```

| í•„ë“œ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `type` | string | í•­ìƒ `"segment"` |
| `segment_id` | int | ì„¸ê·¸ë¨¼íŠ¸ ìˆœë²ˆ |
| `text` | string | ì¸ì‹ëœ í…ìŠ¤íŠ¸ |
| `start_time` | float | ì‹œì‘ ì‹œê°„ (Unix timestamp) |
| `end_time` | float | ì¢…ë£Œ ì‹œê°„ (Unix timestamp) |
| `speaker_changed` | bool | í™”ì ë³€ê²½ ì—¬ë¶€ |
| `speaker_id` | int | í™”ì ID (0ë¶€í„° ì‹œì‘) |
| `confidence` | float | ì‹ ë¢°ë„ (0.0 ~ 1.0) |

### 2. ìµœì¢… ì‘ë‹µ

`"EOS"` ìˆ˜ì‹  í›„ ì „ì†¡

```json
{
  "type": "final",
  "text": "[í™”ì1] ì˜¤ëŠ˜ íšŒì˜ì—ì„œ ë…¼ì˜í•  ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.\n[í™”ì2] ë„¤, ì•Œê² ìŠµë‹ˆë‹¤.",
  "total_segments": 5,
  "total_duration": 30.5,
  "processing_time": 5.2
}
```

| í•„ë“œ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `type` | string | í•­ìƒ `"final"` |
| `text` | string | ì „ì²´ í…ìŠ¤íŠ¸ (í™”ì ë ˆì´ë¸” + ì¤„ë°”ê¿ˆ í¬í•¨) |
| `total_segments` | int | ì´ ì„¸ê·¸ë¨¼íŠ¸ ìˆ˜ |
| `total_duration` | float | ì˜¤ë””ì˜¤ ì´ ê¸¸ì´ (ì´ˆ) |
| `processing_time` | float | ì²˜ë¦¬ ì‹œê°„ (ì´ˆ) |

### 3. ì—ëŸ¬ ì‘ë‹µ

```json
{
  "type": "error",
  "message": "Invalid audio format",
  "code": "INVALID_FORMAT"
}
```

---

## ğŸ’» ì‚¬ìš© ì˜ˆì œ

### Python

```python
import asyncio
import websockets
import wave

async def stream_audio(audio_file: str):
    # WAV íŒŒì¼ ì½ê¸°
    with wave.open(audio_file, 'rb') as wf:
        sample_rate = wf.getframerate()
        pcm_data = wf.readframes(wf.getnframes())
    
    # WebSocket ì—°ê²°
    uri = f"ws://localhost:6470/api/v1/stream?lang=ko&sample_rate={sample_rate}&speaker_change=true"
    
    async with websockets.connect(uri) as ws:
        # ì˜¤ë””ì˜¤ ì²­í¬ ì „ì†¡
        chunk_size = 8000  # 0.25ì´ˆ @ 16kHz
        for i in range(0, len(pcm_data), chunk_size):
            await ws.send(pcm_data[i:i+chunk_size])
            await asyncio.sleep(0.01)  # ì„ íƒì  ë”œë ˆì´
        
        # ì „ì†¡ ì¢…ë£Œ
        await ws.send("EOS")
        
        # ê²°ê³¼ ìˆ˜ì‹ 
        while True:
            response = await ws.recv()
            data = json.loads(response)
            
            if data["type"] == "segment":
                print(f"[{data['segment_id']}] {data['text']}")
                if data["speaker_changed"]:
                    print("  â””â”€ ğŸ”„ í™”ì ë³€ê²½ ê°ì§€!")
            
            elif data["type"] == "final":
                print("\n=== ìµœì¢… ê²°ê³¼ ===")
                print(data["text"])
                break

# ì‹¤í–‰
asyncio.run(stream_audio("meeting.wav"))
```

### JavaScript (ë¸Œë¼ìš°ì €)

```javascript
async function streamAudio(audioBlob, sampleRate = 16000) {
    const ws = new WebSocket(
        `ws://localhost:6470/api/v1/stream?lang=ko&sample_rate=${sampleRate}&speaker_change=true`
    );
    
    ws.binaryType = 'arraybuffer';
    
    ws.onopen = async () => {
        console.log('ì—°ê²°ë¨');
        
        // ArrayBufferë¥¼ ì²­í¬ë¡œ ì „ì†¡
        const arrayBuffer = await audioBlob.arrayBuffer();
        const chunkSize = 8000;
        
        for (let i = 0; i < arrayBuffer.byteLength; i += chunkSize) {
            const chunk = arrayBuffer.slice(i, i + chunkSize);
            ws.send(chunk);
            await new Promise(r => setTimeout(r, 10));
        }
        
        // ì „ì†¡ ì¢…ë£Œ
        ws.send("EOS");
    };
    
    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        if (data.type === 'segment') {
            console.log(`[${data.segment_id}] ${data.text}`);
        } else if (data.type === 'final') {
            console.log('ìµœì¢… ê²°ê³¼:', data.text);
            ws.close();
        }
    };
    
    ws.onerror = (error) => console.error('WebSocket ì—ëŸ¬:', error);
}
```

### cURL (Health Check)

```bash
# ì„œë²„ ìƒíƒœ í™•ì¸
curl -X GET http://localhost:6470/api/v1/health

# ì‘ë‹µ ì˜ˆì‹œ
# {"status":"healthy","whisper_model":"large-v3","device":"cuda","vad_loaded":true,"speaker_model_loaded":true}
```

---

## ğŸ› ï¸ ê´€ë¦¬ API

### ê´€ë¦¬ í˜ì´ì§€
```
http://localhost:6470/admin
```

### ì‚¬ì „ í†µê³„ ì¡°íšŒ
```bash
curl http://localhost:6470/api/v1/admin/stats
```

**ì‘ë‹µ:**
```json
{
    "profanity_count": 79,
    "sensitive_count": 18,
    "proper_noun_count": 124,
    "government_dict_count": 138,
    "abbreviation_count": 120,
    "hallucination_count": 57
}
```

### ì‚¬ì „ ê´€ë¦¬ ì—”ë“œí¬ì¸íŠ¸

| ì—”ë“œí¬ì¸íŠ¸ | ë©”ì„œë“œ | ì„¤ëª… |
|-----------|--------|------|
| `/api/v1/admin/profanity` | GET/POST/DELETE | ë¹„ì†ì–´ í•„í„° |
| `/api/v1/admin/proper-nouns` | GET/POST/DELETE | ê³ ìœ ëª…ì‚¬ ì‚¬ì „ |
| `/api/v1/admin/government-dict` | GET/POST/DELETE | ì •ë¶€ ìš©ì–´ ì‚¬ì „ |
| `/api/v1/admin/abbreviations` | GET/POST/DELETE | ì•½ì–´ ì‚¬ì „ |
| `/api/v1/admin/hallucination` | GET/POST/DELETE | í• ë£¨ì‹œë„¤ì´ì…˜ íŒ¨í„´ |
| `/api/v1/admin/sensitive-patterns` | GET | ë¯¼ê°ì •ë³´ íŒ¨í„´ (ì½ê¸°ì „ìš©) |

### ì‹¤ì‹œê°„ ë¡œê·¸
```
ws://localhost:6470/api/v1/admin/logs
```

---

## ğŸµ íŠ¹ìˆ˜ ê¸°ëŠ¥

### ìŒì•… ê°ì§€

ë°°ê²½ìŒì•…ì´ë‚˜ ë…¸ë˜ê°€ ê°ì§€ë˜ë©´ í…ìŠ¤íŠ¸ ëŒ€ì‹  ë ˆì´ë¸”ë¡œ í‘œì‹œ:

```
[â™ª]        - ë°°ê²½ìŒì•…
[â™ª ë…¸ë˜]   - ë…¸ë˜/ê°€ì‚¬
```

### í™”ì ë³€ê²½ ê°ì§€

í™”ìê°€ ë³€ê²½ë˜ë©´ í…ìŠ¤íŠ¸ì— ì¤„ë°”ê¿ˆ ìë™ ì‚½ì…:

```
êµ­ë¬´ì´ë¦¬ê»˜ì„œ ë‹µë³€í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
ë„¤, ë§ì”€ë“œë¦¬ê² ìŠµë‹ˆë‹¤. í˜„ì¬ ê²½ì œ ìƒí™©ì€...
```

### í›„ì²˜ë¦¬ (ìë™ ì ìš©)

| ê¸°ëŠ¥ | ìˆ˜ëŸ‰ | ì„¤ëª… |
|------|------|------|
| ë¹„ì†ì–´ ë§ˆìŠ¤í‚¹ | 79ê°œ | ë°©ì†¡ ë¶€ì ì ˆ í‘œí˜„ `***` ì²˜ë¦¬ |
| ë¯¼ê°ì •ë³´ ë§ˆìŠ¤í‚¹ | 18ê°œ | ì£¼ë¯¼ë²ˆí˜¸, ì „í™”ë²ˆí˜¸ ë“± |
| ì •ë¶€ ìš©ì–´ êµì • | 138ê°œ | êµ­ë¬´ì´ë‹ˆâ†’êµ­ë¬´ì´ë¦¬ |
| ê³ ìœ ëª…ì‚¬ êµì • | 124ê°œ | ì •ì¹˜ì¸, ì •ë‹¹, ê¸°ê´€ëª… |
| ì•½ì–´ ë³€í™˜ | 120ê°œ | ì•„ì´ì— ì—í”„â†’IMF |
| í• ë£¨ì‹œë„¤ì´ì…˜ í•„í„° | 57ê°œ | ì˜ëª»ëœ ì¸ì‹ ì œê±° |

**ì´ 536ê°œ ì‚¬ì „ í•­ëª© (êµ­íšŒ/êµ­ë¬´íšŒì˜ íŠ¹í™”)**

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **ì˜¤ë””ì˜¤ í˜•ì‹**: ë°˜ë“œì‹œ PCM int16 mono í˜•ì‹ìœ¼ë¡œ ì „ì†¡
2. **ìƒ˜í”Œë ˆì´íŠ¸**: URL íŒŒë¼ë¯¸í„°ì™€ ì‹¤ì œ ì˜¤ë””ì˜¤ ìƒ˜í”Œë ˆì´íŠ¸ ì¼ì¹˜ í•„ìš”
3. **EOS ì „ì†¡**: ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ ì‹œ ë°˜ë“œì‹œ `"EOS"` ë¬¸ìì—´ ì „ì†¡
4. **íƒ€ì„ì•„ì›ƒ**: WebSocket ì—°ê²° íƒ€ì„ì•„ì›ƒ 60ì´ˆ (ping/pong ì§€ì›)

---

## ğŸ“Š ì„±ëŠ¥ ì°¸ê³ 

| í•­ëª© | ê°’ |
|------|---|
| ì‹¤ì‹œê°„ ë¹„ìœ¨ | 5x ~ 10x (GPU ê¸°ì¤€) |
| ì§€ì—° ì‹œê°„ | ì•½ 2ì´ˆ ì´ë‚´ |
| ìµœëŒ€ ë™ì‹œ ì—°ê²° | ì„œë²„ ë¦¬ì†ŒìŠ¤ì— ë”°ë¼ ë‹¤ë¦„ |

---

## ğŸ”§ ë¬¸ì œ í•´ê²°

### ì—°ê²° ì‹¤íŒ¨
```bash
# ì„œë²„ ìƒíƒœ í™•ì¸
curl http://localhost:6470/api/v1/health

# Docker ì»¨í…Œì´ë„ˆ í™•ì¸
docker ps | grep stt-full-service
```

### ì¸ì‹ ê²°ê³¼ ì—†ìŒ
- ì˜¤ë””ì˜¤ í˜•ì‹ í™•ì¸ (PCM int16 mono)
- ìƒ˜í”Œë ˆì´íŠ¸ íŒŒë¼ë¯¸í„° í™•ì¸
- ì˜¤ë””ì˜¤ ë³¼ë¥¨ í™•ì¸ (ë„ˆë¬´ ì‘ìœ¼ë©´ VADê°€ ë¬´ìŒìœ¼ë¡œ íŒë‹¨)

### WebSocket ì—°ê²° ëŠê¹€
- ping_timeout ì„¤ì • í™•ì¸
- ë„¤íŠ¸ì›Œí¬ ìƒíƒœ í™•ì¸
- ì„œë²„ ë¡œê·¸ í™•ì¸: `docker logs stt-full-service`
